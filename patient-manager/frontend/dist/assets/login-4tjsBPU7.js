import{f as D,d as N,r as i,c as P,e as g,w as h,u as j,o as x,a as I,g as V,h as C,V as S,i as u,b as w,t as y}from"./index-DadnvKS_.js";import{a as T,V as F,b as A,c as $}from"./VTextField-B4Uf_z38.js";const q="http://localhost:8090/api",E=T.create({baseURL:q,headers:{"Content-Type":"application/json"}});class z{async login(s){var t,r;try{return(await E.post("/auth/login",s)).data}catch(o){if(T.isAxiosError(o)){const n=o;throw new Error((r=(t=n.response)==null?void 0:t.data)==null?void 0:r.message)}throw new Error("An unexpected error occurred during login")}}async refreshToken(s){var t,r;try{return(await E.post("/auth/refresh",s)).data}catch(o){if(T.isAxiosError(o)){const n=o;throw new Error((r=(t=n.response)==null?void 0:t.data)==null?void 0:r.message)}throw new Error("An unexpected error occurred during token refresh")}}}const U=new z;class v extends Error{}v.prototype.name="InvalidTokenError";function J(e){return decodeURIComponent(atob(e).replace(/(.)/g,(s,t)=>{let r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}function M(e){let s=e.replace(/-/g,"+").replace(/_/g,"/");switch(s.length%4){case 0:break;case 2:s+="==";break;case 3:s+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return J(s)}catch{return atob(s)}}function m(e,s){if(typeof e!="string")throw new v("Invalid token specified: must be a string");s||(s={});const t=s.header===!0?0:1,r=e.split(".")[t];if(typeof r!="string")throw new v(`Invalid token specified: missing part #${t+1}`);let o;try{o=M(r)}catch(n){throw new v(`Invalid token specified: invalid base64 for part #${t+1} (${n.message})`)}try{return JSON.parse(o)}catch(n){throw new v(`Invalid token specified: invalid json for part #${t+1} (${n.message})`)}}const O=D("auth",{state:()=>({accessToken:localStorage.getItem("accessToken")||null,refreshToken:localStorage.getItem("refreshToken")||null,user:null,loading:!1,error:null}),getters:{isAuthenticated:e=>!!e.accessToken,userRole:e=>{if(!e.accessToken)return null;try{return m(e.accessToken).role}catch{return null}},userInfo:e=>{if(!e.accessToken)return null;try{return m(e.accessToken)}catch{return null}},isTokenExpired:e=>{if(!e.accessToken)return!0;try{const s=m(e.accessToken);return Date.now()>=s.exp*1e3}catch{return!0}}},actions:{async login(e,s){var t;this.loading=!0,this.error=null;try{const r=await U.login({email:e,password:s});return this.setTokens(r.accessToken,r.refreshToken),this.user=m(r.accessToken),r}catch(r){throw T.isAxiosError(r)?this.error=(t=r.response)==null?void 0:t.data:this.error="Invalid credentials",r}finally{this.loading=!1}},async refreshTokens(){if(!this.refreshToken)throw this.logout(),new Error(this.error||"Missing refresh token");try{const e=await U.refreshToken({refreshToken:this.refreshToken});return this.setTokens(e.accessToken,e.refreshToken),this.user=m(e.accessToken),e}catch(e){throw this.logout(),e}},setTokens(e,s){this.accessToken=e,this.refreshToken=s,localStorage.setItem("accessToken",e),localStorage.setItem("refreshToken",s)},logout(){this.accessToken=null,this.refreshToken=null,this.user=null,localStorage.removeItem("accessToken"),localStorage.removeItem("refreshToken")},clearError(){this.error=null}}}),K=N({__name:"LoginView",setup(e){const s=j(),t=O(),r=i(""),o=i(""),n=i(""),d=i(""),k=i(!1),p=i(!1),f=i(""),b=i(!1),L=()=>{let l=!0;return r.value.trim()||(n.value="E-mail is required",l=!1),o.value?o.value.length<6&&(d.value="Password must be at least 6 characters",l=!1):(d.value="Password is required",l=!1),l},R=async()=>{if(t.clearError(),!!L())try{await t.login(r.value,o.value),s.push("/")}catch(l){console.error("Login failed:",l)}},B=async()=>{p.value=!0,f.value="";try{const l=await E.get("/test/");f.value="Connection successful",b.value=!0}catch(l){f.value="Connection failed: "+l.message,b.value=!1}finally{p.value=!1}};return(l,a)=>(x(),P("div",null,[g(F,{class:"mx-auto pa-12 pb-8",elevation:"8","max-width":"448",rounded:"lg"},{default:h(()=>[a[6]||(a[6]=I("div",{class:"text-subtitle-1 text-medium-emphasis"}," Account ",-1)),g(A,{modelValue:r.value,"onUpdate:modelValue":a[0]||(a[0]=c=>r.value=c),density:"compact",placeholder:"Email address",type:"email","prepend-inner-icon":"mdi-email-outline",variant:"outlined","error-messages":n.value?[n.value]:[],onFocus:a[1]||(a[1]=c=>n.value="")},null,8,["modelValue","error-messages"]),a[7]||(a[7]=I("div",{class:"text-subtitle-1 text-medium-emphasis d-flex align-center justify-space-between"}," Password ",-1)),g(A,{modelValue:o.value,"onUpdate:modelValue":a[2]||(a[2]=c=>o.value=c),"append-inner-icon":k.value?"mdi-eye-off":"mdi-eye",type:k.value?"text":"password",density:"compact",placeholder:"Enter your password","prepend-inner-icon":"mdi-lock-outline",variant:"outlined","error-messages":d.value?[d.value]:[],"onClick:appendInner":a[3]||(a[3]=c=>k.value=!k.value),onFocus:a[4]||(a[4]=c=>d.value="")},null,8,["modelValue","append-inner-icon","type","error-messages"]),g(S,{class:"mb-8",color:"blue",size:"large",variant:"tonal",block:"",loading:u(t).loading,disabled:u(t).loading,onClick:R},{default:h(()=>[w(y(u(t).loading?"Logging in...":"Log In"),1)]),_:1},8,["loading","disabled"]),u(t).error?(x(),V($,{key:0,type:"error",variant:"tonal",class:"mb-0",closable:"","onClick:close":a[5]||(a[5]=c=>u(t).clearError())},{default:h(()=>[w(y(u(t).error),1)]),_:1})):C("",!0),g(S,{class:"mt-4",color:"grey",variant:"text",size:"small",block:"",loading:p.value,disabled:p.value,onClick:B},{default:h(()=>[w(y(p.value?"Testing...":"Test Connection"),1)]),_:1},8,["loading","disabled"]),f.value?(x(),V($,{key:1,type:b.value?"success":"error",variant:"tonal",class:"mt-2",density:"compact"},{default:h(()=>[w(y(f.value),1)]),_:1},8,["type"])):C("",!0)]),_:1})]))}});export{K as _};
